From e6cbf3dbc65fe74e0578a5bb2649d1bb9a8a1ae0 Mon Sep 17 00:00:00 2001
From: Gabriel Scherer <gabriel.scherer@gmail.com>
Date: Thu, 11 Jul 2019 15:10:50 +0200
Subject: [PATCH 17/42] Unix: we don't support the new (link ?follow) parameter
 on older OCamls

---
 src/batUnix.mliv | 22 +++++++++++++++++++---
 src/batUnix.mlv  |  3 +++
 2 files changed, 22 insertions(+), 3 deletions(-)

diff --git a/src/batUnix.mliv b/src/batUnix.mliv
index 4e50efa9..029dd950 100644
--- a/src/batUnix.mliv
+++ b/src/batUnix.mliv
@@ -587,9 +587,25 @@ val unlink : string -> unit
 val rename : string -> string -> unit
 (** [rename old new] changes the name of a file from [old] to [new]. *)
 
-val link : string -> string -> unit
-(** [link source dest] creates a hard link named [dest] to the file
-    named [source]. *)
+##V<4.8##val link : string -> string -> unit
+##V<4.8##(** [link source dest] creates a hard link named [dest] to the file
+##V<4.8##    named [source]. *)
+##V>=4.8##val link :  ?follow:bool -> string -> string -> unit
+##V>=4.8##(** [link ?follow source dest] creates a hard link named [dest] to the file
+##V>=4.8##   named [source].
+##V>=4.8##
+##V>=4.8##   @param follow indicates whether a [source] symlink is followed or a
+##V>=4.8##   hardlink to [source] itself will be created. On {e Unix} systems this is
+##V>=4.8##   done using the [linkat(2)] function. If [?follow] is not provided, then the
+##V>=4.8##   [link(2)] function is used whose behaviour is OS-dependent, but more widely
+##V>=4.8##   available.
+##V>=4.8##
+##V>=4.8##   @param follow is only available since NEXT_RELEASE and OCaml 4.08.
+##V>=4.8##
+##V>=4.8##   @raise ENOSYS On {e Unix} if [~follow:_] is requested, but linkat is
+##V>=4.8##                 unavailable.
+##V>=4.8##   @raise ENOSYS On {e Windows} if [~follow:false] is requested. *)
+
 
 
 (** {6 File permissions and ownership} *)
diff --git a/src/batUnix.mlv b/src/batUnix.mlv
index a628c2ee..19ac50dc 100644
--- a/src/batUnix.mlv
+++ b/src/batUnix.mlv
@@ -22,6 +22,9 @@
 
 include Unix
 
+##V<4.8##external link : string -> string -> unit = "unix_link"
+##V>=4.8##external link : ?follow:bool -> string -> string -> unit = "unix_link"
+
 ##V<4.2##let write_substring = write
 ##V<4.2##let single_write_substring = single_write
 ##V<4.2##let send_substring = send
-- 
2.22.0

